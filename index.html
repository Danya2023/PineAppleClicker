<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ананас Кликер</title>
  <!-- Подключение библиотеки CryptoJS для шифрования -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* Общие стили */
    body {
      margin: 0;
      padding: 0;
      background: url('assets/Fon.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      width: 100vw;
      height: 100vh;
      padding: 20px;
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    html {
      touch-action: manipulation;
    }
    .counter {
      font-size: 30px;
      color: #fff;
      font-weight: bold;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    .coin-icon {
      width: 30px;
      height: 30px;
      margin-right: 5px;
      vertical-align: middle;
    }
    .clickable {
      width: 250px;
      cursor: pointer;
      transition: transform 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .clickable:hover {
      transform: scale(1.1);
    }
    .top-right {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .top-center {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }
    .top-button {
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #2196F3;
      color: #fff;
      transition: background 0.3s ease;
    }
    .top-button:hover {
      background-color: #1976D2;
    }
    .left-button {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #2196F3;
      color: #fff;
      transition: background 0.3s ease;
    }
    .left-button:hover {
      background-color: #1976D2;
    }
    .footer {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .bottom-buttons {
      display: flex;
      gap: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover {
      transform: scale(1.05);
    }
    .bottom-buttons button {
      background-color: #4CAF50;
      color: #fff;
    }
    .bottom-buttons button:hover {
      background-color: #45a049;
    }
    .daily-button {
      background: linear-gradient(45deg, #FFA500, #FF8C00);
      color: #fff;
    }
    .daily-button:hover {
      background: linear-gradient(45deg, #FF8C00, #FFA500);
    }
    /* Шкала уровня */
    #levelContainer {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }
    #levelContainer div {
      margin: 5px 0;
    }
    #levelBar {
      width: 200px;
      height: 10px;
      background: #555;
      border-radius: 5px;
      overflow: hidden;
      margin: 0 auto;
    }
    #levelProgress {
      width: 0%;
      height: 100%;
      background: #4CAF50;
      transition: width 0.5s ease, background 0.5s ease;
    }
    /* Модальные окна */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px 20px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 100;
      text-align: center;
      width: 90%;
      max-width: 400px;
    }
    .modal button {
      margin-top: 15px;
      background-color: #4CAF50;
      color: #fff;
    }
    .modal button:hover {
      background-color: #45a049;
    }
    .mini-pineapple {
      position: absolute;
      width: 40px;
      height: 40px;
      transition: transform 1s ease-out, opacity 1s ease-out;
      pointer-events: none;
    }
    /* Вкладка «Фоны»: оформляем в виде сетки */
    #backgroundList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      padding: 10px;
    }
    .shop-background {
      width: 150px !important;
      height: 100px !important;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
    }
    .shop-background:hover {
      transform: scale(1.05);
    }
    /* Стили для скинов */
    .shop-skin {
      width: 80px !important;
      height: auto !important;
      object-fit: contain;
      border-radius: 10px;
    }
    .info-icon {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    /* Меню скинов теперь оформлено как сетка, как фоны */
    #skinList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      padding: 10px;
    }
    /* Ежедневные задания */
    #dailyTaskModal {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 20px;
    }
    .daily-task {
      background: #f0f0f0;
      border-radius: 20px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      text-align: center;
    }
    .daily-task h4 {
      margin: 5px 0;
      font-size: 18px;
      color: #333;
    }
    .daily-task p {
      margin: 5px 0;
      font-size: 16px;
      color: #666;
    }
    .daily-task button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(45deg, #FFA500, #FF8C00);
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .daily-task button:hover {
      background: linear-gradient(45deg, #FF8C00, #FFA500);
    }
    #dailyResetTimer {
      margin-top: 10px;
      color: #777;
    }
    #offlineModal {
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }
    #messageModal {
      z-index: 9999;
    }
    #offlineModal button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: #fff;
      cursor: pointer;
    }
    /* Эффект для бустера */
    .booster-active {
      animation: shimmer 1s infinite;
    }
    @keyframes shimmer {
      0% { filter: brightness(1); }
      50% { filter: brightness(1.5); }
      100% { filter: brightness(1); }
    }
    /* Стили для промокодов */
    .promo-container {
      margin-top: 15px;
      text-align: left;
    }
    .promo-container input {
      width: 80%;
      padding: 5px;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .promo-container button {
      font-size: 14px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <!-- Глобальный обработчик ошибок и базовая функция форматирования -->
  <script>
    window.addEventListener("unhandledrejection", function(event) {
      console.error("Unhandled promise rejection:", event.reason);
    });
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function showTemporaryMessage(msg, duration) {
      let modal = document.getElementById("messageModal");
      modal.innerHTML = `<p id="messageText">${msg}</p>`;
      modal.style.display = "block";
      setTimeout(() => { modal.style.display = "none"; }, duration);
    }
    // Функция для форматирования времени (часы, минуты, секунды)
    function formatTime(totalSeconds) {
      let hrs = Math.floor(totalSeconds / 3600);
      let mins = Math.floor((totalSeconds % 3600) / 60);
      let secs = totalSeconds % 60;
      return `${hrs} ч ${mins} м ${secs} с`;
    }
  </script>

  <!-- Основной контейнер игры -->
  <div class="container" id="gameContainer">
    <button class="left-button" onclick="openSettingsModal()">Настройки</button>
    <div class="top-right">
      <button class="top-button" onclick="showCreatorInfo()">Об авторе</button>
    </div>
    <div class="top-center">
      <button class="top-button" onclick="openRating()">Рейтинг</button>
    </div>

    <!-- Шкала уровня -->
    <div id="levelContainer">
      <div>Уровень: <span id="levelDisplay">1</span></div>
      <div id="levelBar">
        <div id="levelProgress"></div>
      </div>
    </div>

    <div class="counter">
      <img src="assets/Сoin.png" alt="Монета" class="coin-icon">
      <span id="coins">0</span>
    </div>
    <img src="assets/PineApple.png" class="clickable" id="pineapple" alt="Ананас">
    <div class="footer">
      <div class="bottom-buttons">
        <button onclick="openShopMenu()">Магазин</button>
        <button onclick="openUpgradeMenu()">Улучшения</button>
      </div>
      <button class="daily-button" onclick="openDailyTaskMenu()">Ежедневные задания</button>
    </div>
  </div>

  <!-- Модальное окно для сообщений -->
  <div class="modal" id="messageModal"></div>

  <!-- Модальные окна магазина и улучшений -->
  <div class="modal" id="shopModal">
    <h3>Магазин</h3>
    <div style="margin-bottom: 15px;">
      <button onclick="openBackgroundMenu()">Фоны</button>
      <button onclick="openSkinMenu()">Скины</button>
    </div>
    <button onclick="closeShopMenu()">Закрыть магазин</button>
  </div>

  <div class="modal" id="upgradeModal">
    <h3>Улучшения</h3>
    <div style="margin-bottom: 15px;">
      <button id="passiveUpgradeBtn" onclick="buyPassiveUpgrade()">Улучшить пассивный доход</button>
      <button id="clickUpgradeBtn" onclick="buyClickUpgrade()">Улучшить клик</button>
      <button id="boosterUpgradeBtn" onclick="activateBooster()">Ускорение</button>
    </div>
    <button onclick="closeUpgradeMenu()">Закрыть улучшения</button>
  </div>

  <!-- Меню выбора фонов -->
  <div class="modal" id="backgroundMenu">
    <h3>Выберите фон</h3>
    <div id="backgroundList"></div>
    <button onclick="closeBackgroundMenu()">Закрыть</button>
  </div>

  <!-- Меню выбора скинов -->
  <div class="modal" id="skinMenu">
    <h3>Выберите скин для ананаса</h3>
    <div id="skinList"></div>
    <button onclick="closeSkinMenu()">Закрыть</button>
  </div>

  <!-- Модальное окно настроек с экспортом/импортом прогресса -->
  <div class="modal" id="settingsModal">
    <h3>Настройки музыки и сохранения</h3>
    <p id="musicStatusText">Музыка включена</p>
    <button onclick="toggleMusic()" id="toggleMusicBtn">Выключить музыку</button>
    <div style="margin-top: 15px;">
      <label for="volumeSlider">Громкость: <span id="volumeValue">100%</span></label>
      <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </div>
    <hr>
    <button onclick="exportProgress()">Экспортировать прогресс</button>
    <button onclick="document.getElementById('importFile').click()">Импортировать прогресс</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importProgress(event)">
    <button onclick="closeSettingsModal()">Закрыть настройки</button>
  </div>

  <!-- Промокоды и информация об игре (об авторе) -->
  <div class="modal" id="creatorModal">
    <h3>Об авторе</h3>
    <p>Создатель игры: ананасик версия 1.0</p>
    <div style="margin-top:10px;">
      <a href="https://www.youtube.com/@AnanasicChickenGun" target="_blank">
        <img src="assets/youtube.png" alt="YouTube" style="width:50px; height:50px;">
      </a>
    </div>
    <!-- Форма ввода промокода -->
    <div class="promo-container">
      <input type="text" id="promoInput" placeholder="Введите промокод">
      <button onclick="checkPromo()">Ввести</button>
    </div>
    <button onclick="closeCreatorModal()">Закрыть</button>
  </div>

  <div class="modal" id="dailyTaskModal"></div>
  <div class="modal" id="offlineModal"></div>

  <!-- Фоновая музыка -->
  <audio id="bgMusic" loop autoplay muted>
    <source src="assets/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Глобальные переменные
    let coins = parseInt(localStorage.getItem("coins")) || 0;
    let baseClickValue = 1;
    let passiveLevel = parseInt(localStorage.getItem("passiveLevel")) || 0;
    let clickUpgradeLevel = parseInt(localStorage.getItem("clickUpgradeLevel")) || 0;
    let clickValue = baseClickValue + clickUpgradeLevel;

    let ownedBackgrounds = JSON.parse(localStorage.getItem("ownedBackgrounds")) || ["assets/Fon.png"];
    let selectedBackground = localStorage.getItem("selectedBackground") || "assets/Fon.png";

    let ownedSkins = JSON.parse(localStorage.getItem("ownedSkins")) || ["assets/PineApple.png"];
    let selectedSkin = localStorage.getItem("selectedSkin") || "assets/PineApple.png";

    let level = parseInt(localStorage.getItem("level")) || 1;
    let dailyLevelUpClaimed = localStorage.getItem("dailyLevelUpClaimed");
    if(dailyLevelUpClaimed === null) {
      dailyLevelUpClaimed = false;
    } else {
      dailyLevelUpClaimed = (dailyLevelUpClaimed === "true");
    }

    // Переменные для подсчёта общего времени игры
    let totalPlayTime = parseInt(localStorage.getItem("totalPlayTime")) || 0; // в секундах
    let sessionStart = Date.now(); // время начала текущей сессии

    // Переменные для бустера "Ускорение"
    let boosterActive = false;
    let boosterCooldown = 1800; // 30 минут в секундах
    let boosterDuration = 30;   // 30 секунд действия
    let boosterCost = 10000;
    let lastBoosterTime = parseInt(localStorage.getItem("lastBoosterTime")) || 0;

    updateCoins();
    updateLevelDisplay();
    updateUpgradeButtons();
    // Обновление кнопок каждую секунду для обновления статуса бустера
    setInterval(updateUpgradeButtons, 1000);

    function updateCoins() {
      document.getElementById("coins").textContent = formatNumber(Math.floor(coins));
      localStorage.setItem("coins", coins);
    }

    function updateLevelDisplay() {
      document.getElementById("levelDisplay").textContent = level;
      updateLevelProgress();
    }

    // Обновление шкалы уровня: если dailyLevelUpClaimed=true – шкала пустая (серая), иначе заполняется зелёным
    function updateLevelProgress() {
      const levelProgress = document.getElementById("levelProgress");
      if (dailyLevelUpClaimed) {
        levelProgress.style.width = "0%";
        levelProgress.style.background = "#aaa";
      } else {
        let tasks = getDailyTasks();
        let claimedCount = tasks.filter(task => task.claimed).length;
        let progressPercent = (claimedCount / 2) * 100;
        levelProgress.style.width = progressPercent + "%";
        levelProgress.style.background = "#4CAF50";
      }
    }

    // Функция рейтинга, показывающая уровень и общее время игры
    function openRating() {
      let highScore = parseInt(localStorage.getItem("localHighScore")) || 0;
      if (coins > highScore) {
        highScore = coins;
        localStorage.setItem("localHighScore", highScore);
      }
      let currentSessionTime = Math.floor((Date.now() - sessionStart) / 1000);
      let totalTime = totalPlayTime + currentSessionTime;
      let html = `<h3>Личный рекорд</h3>
                  <p>Ваш рекорд: ${formatNumber(highScore)}</p>
                  <p>Уровень: ${level}</p>
                  <p>Общее время игры: ${formatTime(totalTime)}</p>
                  <button onclick="closeRating()">Закрыть</button>`;
      document.getElementById("messageModal").innerHTML = html;
      document.getElementById("messageModal").style.display = "block";
    }
    function closeRating() {
      document.getElementById("messageModal").style.display = "none";
    }

    let musicEnabled = localStorage.getItem("musicEnabled");
    if (musicEnabled === null) {
      musicEnabled = true;
      localStorage.setItem("musicEnabled", "true");
    } else {
      musicEnabled = (musicEnabled === "true");
    }
    const bgMusic = document.getElementById("bgMusic");
    let musicVolume = localStorage.getItem("musicVolume");
    if (musicVolume === null) {
      musicVolume = 1;
      localStorage.setItem("musicVolume", musicVolume);
    } else {
      musicVolume = parseFloat(musicVolume);
    }
    bgMusic.volume = musicVolume;
    if (musicEnabled) { bgMusic.play().catch(() => {}); } else { bgMusic.pause(); }
    document.body.addEventListener('click', function() {
      if (bgMusic.muted) { bgMusic.muted = false; if (musicEnabled) bgMusic.play(); }
    }, { once: true });

    window.addEventListener("load", function() {
      document.getElementById("gameContainer").style.backgroundImage = `url('${selectedBackground}')`;
      document.getElementById("pineapple").src = selectedSkin;
      updateUpgradeButtons();
      const volumeSlider = document.getElementById("volumeSlider");
      volumeSlider.value = bgMusic.volume * 100;
      document.getElementById("volumeValue").textContent = `${volumeSlider.value}%`;
      updateLevelDisplay();

      const lastTime = localStorage.getItem("lastTime");
      if (lastTime) {
        const timeDifference = Date.now() - parseInt(lastTime);
        const secondsAway = Math.floor(timeDifference / 1000);
        const offlineCoins = secondsAway * passiveLevel;
        if (offlineCoins > 0) { showOfflineEarnings(offlineCoins); }
      }
    });

    window.addEventListener("load", function() {
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.getElementById("volumeSlider").style.display = "none";
        showTemporaryMessage("Регулировка громкости недоступна на iOS. Используйте системные средства управления громкостью.", 3000);
      }
    });

    function updateLastTime() { localStorage.setItem("lastTime", Date.now()); }
    document.addEventListener('click', updateLastTime);
    document.addEventListener('touchstart', updateLastTime);
    window.addEventListener("beforeunload", function() {
      let sessionTime = Math.floor((Date.now() - sessionStart) / 1000);
      totalPlayTime += sessionTime;
      localStorage.setItem("totalPlayTime", totalPlayTime);
      localStorage.setItem("lastTime", Date.now());
    });
    setInterval(() => { localStorage.setItem("lastTime", Date.now()); }, 60000);
    setInterval(() => { updateDailyTask("playTime", 1); updateLevelProgress(); }, 1000);

    // Обновление общего времени игры при сворачивании/скрытии страницы (важно для Telegram Apps)
    document.addEventListener("visibilitychange", function() {
      if (document.hidden) {
        let sessionTime = Math.floor((Date.now() - sessionStart) / 1000);
        totalPlayTime += sessionTime;
        localStorage.setItem("totalPlayTime", totalPlayTime);
      } else {
        sessionStart = Date.now();
      }
    });

    // Сброс ежедневных заданий через 24 часа
    function resetDailyTasksIfNeeded() {
      let now = Date.now();
      let lastResetTime = localStorage.getItem("lastDailyResetTime");
      if (!lastResetTime || now - parseInt(lastResetTime) >= 86400000) {
        let dailyTasks = [
          { id: "clicks", description: "Накликать 1000 раз", required: 1000, reward: 5000, progress: 0, claimed: false },
          { id: "playTime", description: "Поиграть 10 минут", required: 600, reward: 3000, progress: 0, claimed: false }
        ];
        localStorage.setItem("dailyTasks", JSON.stringify(dailyTasks));
        localStorage.setItem("lastDailyResetTime", now.toString());
        localStorage.setItem("dailyLevelUpClaimed", "false");
        dailyLevelUpClaimed = false;
      }
    }
    function getDailyTasks() {
      resetDailyTasksIfNeeded();
      return JSON.parse(localStorage.getItem("dailyTasks"));
    }
    function updateDailyTask(taskId, increment) {
      let tasks = getDailyTasks();
      tasks.forEach(task => {
        if (task.id === taskId) {
          task.progress += increment;
          if (task.progress > task.required) task.progress = task.required;
        }
      });
      localStorage.setItem("dailyTasks", JSON.stringify(tasks));
      updateLevelProgress();
    }
    function claimDailyTaskReward(taskId) {
      let tasks = getDailyTasks();
      let updated = false;
      tasks.forEach(task => {
        if (task.id === taskId && !task.claimed && task.progress >= task.required) {
          coins += task.reward;
          task.claimed = true;
          updateCoins();
          updated = true;
        }
      });
      if (updated) {
        localStorage.setItem("dailyTasks", JSON.stringify(tasks));
        openDailyTaskMenu();
      }
    }
    function openDailyTaskMenu() {
      let tasks = getDailyTasks();
      let html = `<h3>Ежедневные задания</h3>`;
      tasks.forEach(task => {
        html += `<div class="daily-task">
          <h4>${task.description}</h4>
          <p>Прогресс: ${formatNumber(task.progress)} / ${formatNumber(task.required)}</p>`;
        if (!task.claimed && task.progress >= task.required) {
          html += `<button onclick="claimDailyTaskReward('${task.id}')">Получить награду</button>`;
        } else if (task.claimed) {
          html += `<p style="color:green; font-weight:bold;">Награда получена</p>`;
        }
        html += `</div>`;
      });
      if (tasks.every(task => task.claimed) && !dailyLevelUpClaimed) {
        html += `<button id="levelUpBtn" onclick="levelUp()">Получить уровень (+100к монет)</button>`;
      }
      html += `<p id="dailyResetTimer"></p>`;
      html += `<button onclick="closeDailyTaskMenu()">Закрыть</button>`;
      document.getElementById("dailyTaskModal").innerHTML = html;
      document.getElementById("dailyTaskModal").style.display = "block";
      startDailyResetTimer();
    }
    function closeDailyTaskMenu() {
      document.getElementById("dailyTaskModal").style.display = "none";
    }
    function levelUp() {
      if (dailyLevelUpClaimed) return;
      let btn = document.getElementById("levelUpBtn");
      if (btn) { btn.disabled = true; }
      document.getElementById("levelProgress").style.width = "100%";
      setTimeout(() => {
        level++;
        coins += 100000;
        localStorage.setItem("level", level);
        dailyLevelUpClaimed = true;
        localStorage.setItem("dailyLevelUpClaimed", "true");
        updateLevelDisplay();
        updateCoins();
        showTemporaryMessage("Поздравляем! Вы получили новый уровень!", 2000);
        closeDailyTaskMenu();
      }, 500);
    }
    function startDailyResetTimer() {
      let now = Date.now();
      let lastResetTime = localStorage.getItem("lastDailyResetTime") || now;
      let nextReset = parseInt(lastResetTime) + 86400000;
      let remainingTime = nextReset - now;
      if (remainingTime < 0) remainingTime = 0;
      function updateTimer() {
        let hours = Math.floor(remainingTime / (1000 * 60 * 60));
        let minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        let seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
        let timerElement = document.getElementById("dailyResetTimer");
        if (timerElement) {
          timerElement.textContent = `Обновление через: ${hours}ч ${minutes}м ${seconds}с`;
        }
        remainingTime -= 1000;
        if (remainingTime >= 0) {
          setTimeout(updateTimer, 1000);
        }
      }
      updateTimer();
    }

    // Изменённое событие клика по ананасу с учетом бустера
    document.getElementById("pineapple").addEventListener("click", function(event) {
      let multiplier = boosterActive ? 2 : 1;
      coins += clickValue * multiplier;
      updateCoins();
      updateDailyTask("clicks", 1);
      this.style.transition = "transform 0.2s ease";
      this.style.transform = "scale(1.2) rotate(10deg)";
      setTimeout(() => { this.style.transform = "scale(1) rotate(0deg)"; }, 200);
      createPineappleExplosion(event.clientX, event.clientY);
    });
    function createPineappleExplosion(x, y) {
      for (let i = 0; i < 10; i++) {
        let miniPineapple = document.createElement("img");
        miniPineapple.src = "assets/PineApple.png"; 
        miniPineapple.classList.add("mini-pineapple");
        document.body.appendChild(miniPineapple);
        let angle = Math.random() * Math.PI * 2;
        let distance = Math.random() * 100 + 50;
        let targetX = x + Math.cos(angle) * distance;
        let targetY = y + Math.sin(angle) * distance;
        miniPineapple.style.left = `${x}px`;
        miniPineapple.style.top = `${y}px`;
        setTimeout(() => {
          miniPineapple.style.transform = `translate(${targetX - x}px, ${targetY - y}px) scale(0.5)`;
          miniPineapple.style.opacity = "0";
        }, 10);
        setTimeout(() => { miniPineapple.remove(); }, 1000);
      }
    }
    setInterval(() => { coins += passiveLevel; updateCoins(); }, 1000);

    function openShopMenu() { document.getElementById("shopModal").style.display = "block"; }
    function closeShopMenu() { document.getElementById("shopModal").style.display = "none"; }
    function openUpgradeMenu() { document.getElementById("upgradeModal").style.display = "block"; }
    function closeUpgradeMenu() { document.getElementById("upgradeModal").style.display = "none"; }

    function openBackgroundMenu() {
      closeShopMenu();
      let menu = document.getElementById("backgroundList");
      menu.innerHTML = "";
      let backgrounds = [
        { price: 100000, path: "assets/FonShop1.png", info: "Лето с интересными тропическими деревьями" },
        { price: 1000000, path: "assets/FonShop2.png", info: "Зима красиво, но холодно" },
        { price: 10000000, path: "assets/FonShop3.png", info: "Горы и машины, что может быть лучше этого" },
        { price: 100000000, path: "assets/FonShop4.png", info: "Марс - неизведанное и таинственное место, ну хоть ананас побывает первым на марсе" }
      ];
      backgrounds.forEach(bg => {
        let bgCard = document.createElement("div");
        bgCard.style.display = "flex";
        bgCard.style.flexDirection = "column";
        bgCard.style.alignItems = "center";
        let img = document.createElement("img");
        img.src = bg.path;
        img.classList.add("shop-background");
        let infoImg = document.createElement("img");
        infoImg.src = "assets/exclamation mark.png";
        infoImg.classList.add("info-icon");
        infoImg.onclick = function(e) { e.stopPropagation(); showMessage(bg.info); };
        let button = document.createElement("button");
        if(bg.path === "assets/FonShop4.png" && level < 20) {
          button.textContent = "Требуется 20 уровень";
          button.onclick = function() { showMessage("Достигните 20 уровня, чтобы купить этот фон!"); };
        } else {
          if (ownedBackgrounds.includes(bg.path)) {
            button.textContent = (selectedBackground === bg.path ? "Выбран" : "Выбрать");
          } else {
            button.innerHTML = `Купить за ${formatNumber(bg.price)} <img src="assets/Сoin.png" alt="Монета" style="width:16px; height:16px; vertical-align:middle;">`;
          }
          button.onclick = function() {
            if (!ownedBackgrounds.includes(bg.path)) { buyBackground(bg.price, bg.path); }
            else { selectBackground(bg.path); }
          };
        }
        bgCard.appendChild(img);
        bgCard.appendChild(infoImg);
        bgCard.appendChild(button);
        menu.appendChild(bgCard);
      });
      document.getElementById("backgroundMenu").style.display = "block";
    }
    function closeBackgroundMenu() { document.getElementById("backgroundMenu").style.display = "none"; }
    function selectBackground(path) {
      selectedBackground = path;
      localStorage.setItem("selectedBackground", selectedBackground);
      document.getElementById("gameContainer").style.backgroundImage = `url('${selectedBackground}')`;
      closeBackgroundMenu();
    }
    function buyBackground(price, path) {
      if (coins >= price) {
        coins -= price;
        ownedBackgrounds.push(path);
        localStorage.setItem("ownedBackgrounds", JSON.stringify(ownedBackgrounds));
        updateCoins();
        openBackgroundMenu();
      } else { showMessage("Не хватает монет для покупки фона!"); }
    }

    function openSkinMenu() {
      document.getElementById("shopModal").style.display = "none";
      let menu = document.getElementById("skinList");
      menu.innerHTML = "";
      let skins = [
        { price: 1000000, path: "assets/Skin1.png", shopPath: "assets/Skin1_locked.png", lockedPath: "assets/Skin1_locked.png", info: "Пиксельный ананас" },
        { price: 10000000, path: "assets/Skin2.png", shopPath: "assets/Skin2_locked.png", lockedPath: "assets/Skin2_locked.png", info: "Ананас в стиле модника, красивый и всегда следит за модой" },
        { price: 100000000, path: "assets/Skin3.png", shopPath: "assets/Skin3.png", lockedPath: "assets/Skin3_locked.png", info: "Самый редкий скин в игре - золотой ананас, его имеют только 1% из всех игроков" }
      ];
      skins.forEach(skin => {
        let skinCard = document.createElement("div");
        skinCard.style.display = "flex";
        skinCard.style.flexDirection = "column";
        skinCard.style.alignItems = "center";
        let img = document.createElement("img");
        img.src = ownedSkins.includes(skin.path) ? skin.path : skin.lockedPath;
        img.classList.add("shop-skin");
        let infoImg = document.createElement("img");
        infoImg.src = "assets/exclamation mark.png";
        infoImg.classList.add("info-icon");
        infoImg.onclick = function(e) { e.stopPropagation(); showMessage(skin.info); };
        let button = document.createElement("button");
        if(skin.path === "assets/Skin3.png" && level < 20) {
          button.textContent = "Требуется 20 уровень";
          button.onclick = function() { showMessage("Достигните 20 уровня, чтобы купить этот скин!"); };
        } else {
          if (ownedSkins.includes(skin.path)) {
            button.textContent = (selectedSkin === skin.path ? "Выбран" : "Выбрать");
          } else {
            button.innerHTML = `Купить за ${formatNumber(skin.price)} <img src="assets/Сoin.png" alt="Монета" style="width:16px; height:16px; vertical-align:middle;">`;
          }
          button.onclick = function() {
            if (!ownedSkins.includes(skin.path)) { buySkin(skin.price, skin.path); }
            else { selectSkin(skin.path); }
          };
        }
        skinCard.appendChild(img);
        skinCard.appendChild(infoImg);
        skinCard.appendChild(button);
        menu.appendChild(skinCard);
      });
      document.getElementById("skinMenu").style.display = "block";
    }
    function closeSkinMenu() { document.getElementById("skinMenu").style.display = "none"; }
    function selectSkin(path) {
      selectedSkin = path;
      localStorage.setItem("selectedSkin", selectedSkin);
      document.getElementById("pineapple").src = selectedSkin;
      closeSkinMenu();
    }
    function buySkin(price, path) {
      if (coins >= price) {
        coins -= price;
        ownedSkins.push(path);
        localStorage.setItem("ownedSkins", JSON.stringify(ownedSkins));
        updateCoins();
        openSkinMenu();
      } else { showMessage("Не хватает монет для покупки скина!"); }
    }

    function buyPassiveUpgrade() {
      let cost = 50 * (passiveLevel + 1);
      if (coins >= cost) {
        coins -= cost;
        passiveLevel++;
        localStorage.setItem("passiveLevel", passiveLevel);
        updateCoins();
        updateUpgradeButtons();
      } else { showMessage("Не хватает монет для улучшения пассивного дохода!"); }
    }
    function buyClickUpgrade() {
      let cost = 50 * (clickUpgradeLevel + 1);
      if (coins >= cost) {
        coins -= cost;
        clickUpgradeLevel++;
        clickValue = baseClickValue + clickUpgradeLevel;
        localStorage.setItem("clickUpgradeLevel", clickUpgradeLevel);
        updateCoins();
        updateUpgradeButtons();
      } else { showMessage("Не хватает монет для улучшения клика!"); }
    }
    // Функция обновления кнопок улучшений, включая кнопку бустера "Ускорение"
    function updateUpgradeButtons() {
      let passiveBtn = document.getElementById("passiveUpgradeBtn");
      let clickBtn = document.getElementById("clickUpgradeBtn");
      let boosterBtn = document.getElementById("boosterUpgradeBtn");
      let passiveCost = 50 * (passiveLevel + 1);
      let clickCost = 50 * (clickUpgradeLevel + 1);
      passiveBtn.innerHTML = `Улучшить пассивный доход (Уровень: ${passiveLevel}, Цена: ${formatNumber(passiveCost)} <img src="assets/Сoin.png" alt="Монета" style="width:16px; height:16px; vertical-align:middle;">)`;
      clickBtn.innerHTML = `Улучшить клик (Уровень: ${clickUpgradeLevel}, Цена: ${formatNumber(clickCost)} <img src="assets/Сoin.png" alt="Монета" style="width:16px; height:16px; vertical-align:middle;">)`;

      // Логика для кнопки бустера "Ускорение"
      if(level < 5) {
        boosterBtn.textContent = "Ускорение (доступно с 5 уровня)";
        boosterBtn.disabled = false;
      } else {
        let now = Date.now();
        if(now - lastBoosterTime < boosterCooldown * 1000) {
          let remaining = Math.ceil((boosterCooldown * 1000 - (now - lastBoosterTime))/1000);
          boosterBtn.textContent = `Ускорение (Осталось: ${remaining} сек)`;
          boosterBtn.disabled = true;
        } else {
          boosterBtn.textContent = `Ускорение (Стоимость: ${formatNumber(boosterCost)})`;
          boosterBtn.disabled = false;
        }
      }
    }
    function showMessage(msg) {
      let modal = document.getElementById("messageModal");
      modal.innerHTML = `<p id="messageText">${msg}</p>
                           <button onclick="closeMessage()">Закрыть</button>`;
      modal.style.display = "block";
    }
    function closeMessage() { document.getElementById("messageModal").style.display = "none"; }
    // Обновлённая функция "Об авторе" с промокодом
    function showCreatorInfo() {
      document.getElementById("creatorModal").style.display = "block";
    }
    function closeCreatorModal() {
      document.getElementById("creatorModal").style.display = "none";
    }
    // Функция проверки промокода
    function checkPromo() {
      const promoInput = document.getElementById("promoInput").value.trim();
      const PROMO_CODE = "ONE-MILLION";
      if(localStorage.getItem("promoOneMillion") === "true") {
        showMessage("Вы уже вводили этот промокод.");
        return;
      }
      if(promoInput === PROMO_CODE) {
        coins += 1000000;
        localStorage.setItem("coins", coins);
        localStorage.setItem("promoOneMillion", "true");
        updateCoins();
        showMessage("Поздравляем! Вы получили 1.000.000 монет.");
      } else {
        showMessage("Неверный промокод.");
      }
    }
    function openSettingsModal() { updateMusicStatus(); document.getElementById("settingsModal").style.display = "block"; }
    function closeSettingsModal() { document.getElementById("settingsModal").style.display = "none"; }
    function updateMusicStatus() {
      const statusText = document.getElementById("musicStatusText");
      const toggleBtn = document.getElementById("toggleMusicBtn");
      if (musicEnabled) { statusText.textContent = "Музыка включена"; toggleBtn.textContent = "Выключить музыку"; }
      else { statusText.textContent = "Музыка выключена"; toggleBtn.textContent = "Включить музыку"; }
    }
    function toggleMusic() {
      musicEnabled = !musicEnabled;
      localStorage.setItem("musicEnabled", musicEnabled ? "true" : "false");
      if (musicEnabled) { bgMusic.play(); } else { bgMusic.pause(); }
      updateMusicStatus();
    }
    document.getElementById("volumeSlider").addEventListener("input", function() {
      let volume = this.value / 100;
      bgMusic.volume = volume;
      localStorage.setItem("musicVolume", volume);
      document.getElementById("volumeValue").textContent = `${this.value}%`;
    });

    // Экспорт и импорт прогресса с шифрованием
    const SECRET_KEY = "mySuperSecretKey123";
    function exportProgress() {
      const progress = {
        coins: localStorage.getItem("coins"),
        passiveLevel: localStorage.getItem("passiveLevel"),
        clickUpgradeLevel: localStorage.getItem("clickUpgradeLevel"),
        ownedBackgrounds: localStorage.getItem("ownedBackgrounds"),
        selectedBackground: localStorage.getItem("selectedBackground"),
        ownedSkins: localStorage.getItem("ownedSkins"),
        selectedSkin: localStorage.getItem("selectedSkin"),
        localHighScore: localStorage.getItem("localHighScore"),
        lastDailyReset: localStorage.getItem("lastDailyResetTime"),
        dailyTasks: localStorage.getItem("dailyTasks"),
        musicEnabled: localStorage.getItem("musicEnabled"),
        musicVolume: localStorage.getItem("musicVolume"),
        level: localStorage.getItem("level"),
        dailyLevelUpClaimed: localStorage.getItem("dailyLevelUpClaimed"),
        totalPlayTime: localStorage.getItem("totalPlayTime")
      };
      const dataStr = JSON.stringify(progress, null, 2);
      const encrypted = CryptoJS.AES.encrypt(dataStr, SECRET_KEY).toString();
      const blob = new Blob([encrypted], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      // Для мобильных устройств вместо автоматического скачивания выводим ссылку
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        showMessage(`Нажмите и удерживайте ссылку, чтобы скачать файл:<br>
                     <a href="${url}" download="progress.json">Скачать прогресс</a>`);
      } else {
        const a = document.createElement("a");
        a.href = url;
        a.download = "progress.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Прогресс сохранен! Ваш текущий счет: " + formatNumber(coins) + " монет.");
      }
    }
    function importProgress(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const decrypted = CryptoJS.AES.decrypt(e.target.result, SECRET_KEY).toString(CryptoJS.enc.Utf8);
          if (!decrypted) {
            throw new Error("Неверный секретный ключ или файл был изменён.");
          }
          const importedData = JSON.parse(decrypted);
          if(importedData.coins !== undefined) localStorage.setItem("coins", importedData.coins);
          if(importedData.passiveLevel !== undefined) localStorage.setItem("passiveLevel", importedData.passiveLevel);
          if(importedData.clickUpgradeLevel !== undefined) localStorage.setItem("clickUpgradeLevel", importedData.clickUpgradeLevel);
          if(importedData.ownedBackgrounds !== undefined) localStorage.setItem("ownedBackgrounds", importedData.ownedBackgrounds);
          if(importedData.selectedBackground !== undefined) localStorage.setItem("selectedBackground", importedData.selectedBackground);
          if(importedData.ownedSkins != null && Array.isArray(importedData.ownedSkins) && importedData.ownedSkins.length > 0) {
            localStorage.setItem("ownedSkins", JSON.stringify(importedData.ownedSkins));
          } else {
            localStorage.setItem("ownedSkins", JSON.stringify(["assets/PineApple.png"]));
          }
          if(importedData.selectedSkin != null && importedData.selectedSkin !== "") {
            localStorage.setItem("selectedSkin", importedData.selectedSkin);
          } else {
            localStorage.setItem("selectedSkin", "assets/PineApple.png");
          }
          if(importedData.localHighScore !== undefined) localStorage.setItem("localHighScore", importedData.localHighScore);
          if(importedData.lastDailyReset !== undefined) localStorage.setItem("lastDailyResetTime", importedData.lastDailyReset);
          if(importedData.dailyTasks !== undefined) localStorage.setItem("dailyTasks", importedData.dailyTasks);
          if(importedData.musicEnabled !== undefined) localStorage.setItem("musicEnabled", importedData.musicEnabled);
          if(importedData.musicVolume !== undefined) localStorage.setItem("musicVolume", importedData.musicVolume);
          if(importedData.level !== undefined) localStorage.setItem("level", importedData.level);
          if(importedData.dailyLevelUpClaimed !== undefined) localStorage.setItem("dailyLevelUpClaimed", importedData.dailyLevelUpClaimed);
          if(importedData.totalPlayTime !== undefined) localStorage.setItem("totalPlayTime", importedData.totalPlayTime);
          location.reload();
        } catch (error) {
          alert("Ошибка при импорте данных: " + error);
        }
      };
      reader.readAsText(file);
    }
    
    function showOfflineEarnings(earned) {
      let offlineModal = document.getElementById("offlineModal");
      let secondsAway = passiveLevel > 0 ? earned / passiveLevel : 0;
      offlineModal.innerHTML = 
        `<h3>Оффлайн доход</h3>
        <p>Вы отсутствовали ${Math.floor(secondsAway)} секунд и заработали ${formatNumber(earned)} монет!</p>
        <button onclick="claimOfflineEarnings(${earned})">Забрать доход</button>
        <button onclick="closeOfflineModal()">Отмена</button>`;
      offlineModal.style.display = "block";
    }
    function claimOfflineEarnings(earned) {
      coins += earned;
      updateCoins();
      closeOfflineModal();
      showMessage(`Вы получили ${formatNumber(earned)} монет за оффлайн время!`);
      localStorage.setItem("lastTime", Date.now());
    }
    function closeOfflineModal() { document.getElementById("offlineModal").style.display = "none"; }

    // Функция активации бустера "Ускорение"
    function activateBooster() {
      if(level < 5) {
        showMessage("Достигните 5 уровня, чтобы купить улучшение \"Ускорение\".");
        return;
      }
      let now = Date.now();
      if(now - lastBoosterTime < boosterCooldown * 1000) {
        let remaining = Math.ceil((boosterCooldown * 1000 - (now - lastBoosterTime)) / 1000);
        showMessage(`Бустер можно использовать через ${remaining} секунд.`);
        return;
      }
      if(coins < boosterCost) {
        showMessage("Не хватает монет для покупки ускорения!");
        return;
      }
      coins -= boosterCost;
      updateCoins();
      boosterActive = true;
      lastBoosterTime = now;
      localStorage.setItem("lastBoosterTime", lastBoosterTime);
      // Добавляем визуальный эффект: фон начинает блестеть
      document.getElementById("gameContainer").classList.add("booster-active");
      showMessage("Бустер активирован на 30 секунд!");
      updateUpgradeButtons();
      setTimeout(() => {
        boosterActive = false;
        document.getElementById("gameContainer").classList.remove("booster-active");
        updateUpgradeButtons();
      }, boosterDuration * 1000);
    }
  </script>
</body>
</html>
